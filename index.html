<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Kas Cluster MoonLake</title>
    
    <!-- Google Font: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Library untuk Export PDF & Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #0f172a;
            --secondary-color: #1e293b;
            --accent-color: #3b82f6;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --info-color: #06b6d4;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* --- FITUR LOGIN: STYLE UNTUK HALAMAN LOGIN --- */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }
        .login-card {
            background: var(--bg-primary);
            padding: 3rem;
            border-radius: 1rem;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .login-card .logo {
            max-height: 60px;
            margin-bottom: 1.5rem;
            border-radius: 8px;
        }
        .login-card h2 {
            margin-bottom: 2rem;
            color: var(--primary-color);
        }
        .login-form .form-group {
            text-align: left;
            margin-bottom: 1.5rem;
        }
        .login-form .btn {
            width: 100%;
            justify-content: center;
        }
        .login-error {
            color: var(--danger-color);
            font-size: 0.9rem;
            margin-top: 1rem;
            display: none;
        }
        /* ------------------------------------------- */

        .app-container {
            display: none;
        }

        /* ===== HEADER DESIGN ===== */
        header {
            background-color: var(--bg-primary);
            padding: 1.5rem 0;
            box-shadow: var(--shadow-sm);
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        header .container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
        }

        header .logo {
            max-height: 60px;
            border-radius: 8px;
        }

        header .header-text h1 {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--primary-color);
            text-align: right;
        }
        
        header .header-text p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-align: right;
            font-weight: 400;
        }
        /* ========================= */

        /* --- PERUBAHAN: STYLE UNTUK USER PROFILE DROPDOWN --- */
        .user-profile {
            position: relative;
        }

        .profile-trigger {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .profile-trigger:hover {
            background-color: var(--bg-secondary);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1rem;
            text-transform: uppercase;
        }

        .user-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            background-color: var(--bg-primary);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-lg);
            min-width: 180px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease-in-out;
        }

        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .dropdown-menu::before {
            content: '';
            position: absolute;
            top: -8px;
            right: 20px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid var(--bg-primary);
        }

        .dropdown-menu a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .dropdown-menu a:hover {
            background-color: var(--bg-secondary);
        }

        .dropdown-menu a i {
            width: 16px;
            text-align: center;
        }
        /* --------------------------------------------------- */

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .month-picker label {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .month-picker input[type="month"] {
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            transition: border-color 0.2s;
        }

        .month-picker input[type="month"]:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .btn-group {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--shadow-sm);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background-color: var(--bg-primary);
            padding: 1.5rem 2rem;
            border-radius: 1rem;
            box-shadow: var(--shadow-md);
            border-left: 5px solid;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .card-income { border-left-color: var(--success-color); }
        .card-expense { border-left-color: var(--danger-color); }
        .card-balance { border-left-color: var(--accent-color); }
        .card-total { border-left-color: var(--info-color); }

        .card-header {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        .card-body .amount {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .transaction-table {
            background-color: var(--bg-primary);
            border-radius: 1rem;
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background-color: var(--bg-secondary);
        }

        th {
            padding: 1rem 1.5rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.05em;
        }

        td {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        
        tbody tr {
            transition: background-color 0.2s;
        }

        tbody tr:hover {
            background-color: #f1f5f9;
        }

        tbody tr:nth-child(even) {
            background-color: #fcfdff;
        }

        tbody tr:nth-child(even):hover {
            background-color: #f1f5f9;
        }
        
        .badge {
            padding: 0.35rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .badge-income {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .badge-expense {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .action-buttons button {
            margin-right: 0.5rem;
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--bg-primary);
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            animation: slideUp 0.3s;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s;
        }
        
        .close-btn:hover {
            color: var(--danger-color);
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group textarea {
            resize: vertical;
        }

        .radio-group {
            display: flex;
            gap: 2rem;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-weight: 400;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .hidden {
            display: none !important;
        }

        /* Print Styles */
        @media print {
            body {
                background-color: white;
            }
            .controls, .modal, .action-buttons, .btn-secondary, .btn-primary, .user-profile {
                display: none !important;
            }
            .container {
                padding: 0;
            }
            header {
                box-shadow: none;
                border-bottom: 2px solid #000;
                margin-bottom: 1rem;
            }
            header .header-text h1, header .header-text p {
                color: #000;
            }
            .transaction-table {
                box-shadow: none;
                border: 1px solid #000;
            }
            th, td {
                padding: 0.5rem;
                border: 1px solid #ddd;
            }
            .card {
                box-shadow: none;
                border: 1px solid #ccc;
                break-inside: avoid;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>

    <!-- --- FITUR LOGIN: HALAMAN LOGIN --- -->
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <img src="https://placehold.co/200x60/0f172a/ffffff?text=Cibubur+Country" alt="Logo Cibubur Country" class="logo">
            <h2>Selamat Datang</h2>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">Silakan login untuk melihat laporan keuangan.</p>
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" placeholder="Masukkan username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Masukkan password" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                <div id="loginError" class="login-error">Username atau password salah!</div>
            </form>
        </div>
    </div>
    <!-- -------------------------------- -->

    <!-- Aplikasi Utama -->
    <div id="appContainer" class="app-container">
        <header>
            <div class="container">
                <img src="https://placehold.co/200x60/0f172a/ffffff?text=Cibubur+Country" alt="Logo Cibubur Country" class="logo">
                <div class="header-text">
                    <h1>Laporan Kas Cluster MoonLake Cibubur Country Cikeas Gunung Putri Bogor</h1>
                    <p>Periode Laporan Keuangan</p>
                </div>
                <!-- --- PERUBAHAN: KONTAINER UNTUK USER PROFILE DROPDOWN --- -->
                <div id="authButtonContainer">
                    <!-- Akan diisi oleh JavaScript -->
                </div>
                <!-- -------------------------------------------------------- -->
            </div>
        </header>

        <main class="container">
            <div class="controls">
                <div class="month-picker">
                    <label for="monthPicker">Laporan Bulan:</label>
                    <input type="month" id="monthPicker">
                </div>
                <div class="btn-group">
                    <button id="addTransactionBtn" class="btn btn-primary hidden">
                        <i class="fas fa-plus-circle"></i> Tambah Transaksi
                    </button>
                    <button class="btn btn-secondary" id="printBtn">
                        <i class="fas fa-print"></i> Cetak
                    </button>
                    <button class="btn btn-secondary" id="exportPdfBtn">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                    <button class="btn btn-secondary" id="exportExcelBtn">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                </div>
            </div>

            <div id="printableArea">
                <section class="summary-cards">
                    <div class="card card-income">
                        <div class="card-header">Total Pemasukan</div>
                        <div class="card-body">
                            <div class="amount" id="totalIncome">Rp 0</div>
                        </div>
                    </div>
                    <div class="card card-expense">
                        <div class="card-header">Total Pengeluaran</div>
                        <div class="card-body">
                            <div class="amount" id="totalExpense">Rp 0</div>
                        </div>
                    </div>
                    <div class="card card-balance">
                        <div class="card-header">Saldo Bulan Ini</div>
                        <div class="card-body">
                            <div class="amount" id="totalBalance">Rp 0</div>
                        </div>
                    </div>
                    <div class="card card-total">
                        <div class="card-header">Total Kas Keseluruhan</div>
                        <div class="card-body">
                            <div class="amount" id="totalOverallBalance">Rp 0</div>
                        </div>
                    </div>
                </section>

                <section class="transaction-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>Keterangan</th>
                                <th>Kategori</th>
                                <th>Jenis</th>
                                <th>Jumlah</th>
                                <th id="actionHeader" class="hidden">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="transactionTableBody">
                            <!-- Data akan diisi oleh JavaScript -->
                        </tbody>
                    </table>
                </section>
            </div>
        </main>
    </div>

    <!-- Modal for Add/Edit Transaction -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Tambah Transaksi Baru</h2>
                <button class="close-btn" id="closeModalBtn">&times;</button>
            </div>
            <form id="transactionForm">
                <input type="hidden" id="transactionId">
                <div class="form-group">
                    <label for="date">Tanggal</label>
                    <input type="date" id="date" required>
                </div>
                <div class="form-group">
                    <label for="description">Keterangan</label>
                    <textarea id="description" rows="2" required></textarea>
                </div>
                <div class="form-group">
                    <label for="category">Kategori</label>
                    <select id="category" required>
                        <option value="">-- Pilih Kategori --</option>
                        <optgroup label="Pemasukan">
                            <option value="Iuran Warga">Iuran Warga</option>
                            <option value="Sumbangan Sukarela">Sumbangan Sukarela</option>
                            <option value="Hasil Usaha RT/RW">Hasil Usaha RT/RW</option>
                            <option value="Lainnya (Pemasukan)">Lainnya (Pemasukan)</option>
                        </optgroup>
                        <optgroup label="Pengeluaran">
                            <option value="Kebersihan">Kebersihan</option>
                            <option value="Keamanan (Satpam)">Keamanan (Satpam)</option>
                            <option value="Listrik & Air">Listrik & Air</option>
                            <option value="Konsumsi Rapat">Konsumsi Rapat</option>
                            <option value="Perbaikan Fasilitas">Perbaikan Fasilitas</option>
                            <option value="Administrasi">Administrasi</option>
                            <option value="Lainnya (Pengeluaran)">Lainnya (Pengeluaran)</option>
                        </optgroup>
                    </select>
                </div>
                <div class="form-group">
                    <label>Jenis Transaksi</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="type" value="pemasukan" required> Pemasukan
                        </label>
                        <label>
                            <input type="radio" name="type" value="pengeluaran" required> Pengeluaran
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="amount">Jumlah (Rp)</label>
                    <input type="number" id="amount" min="0" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- SISTEM LOGIN MULTI-USER ---
            const ADMIN_CREDENTIALS = { username: 'admin', password: 'admin123' };
            const VIEWONLY_CREDENTIALS = { username: 'moonlake', password: 'moonlake' };
            const AUTH_USER_KEY = 'kasRT_loggedInUser';
            
            const loginContainer = document.getElementById('loginContainer');
            const appContainer = document.getElementById('appContainer');
            const loginForm = document.getElementById('loginForm');
            const loginError = document.getElementById('loginError');
            const authButtonContainer = document.getElementById('authButtonContainer');
            
            const addTransactionBtn = document.getElementById('addTransactionBtn');
            const actionHeader = document.getElementById('actionHeader');
            
            let currentUserRole = null;
            // ----------------------------------------------------

            // --- ELEMEN DOM LAINNYA ---
            const monthPicker = document.getElementById('monthPicker');
            const printBtn = document.getElementById('printBtn');
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            const transactionTableBody = document.getElementById('transactionTableBody');
            const totalIncomeEl = document.getElementById('totalIncome');
            const totalExpenseEl = document.getElementById('totalExpense');
            const totalBalanceEl = document.getElementById('totalBalance');
            const totalOverallBalanceEl = document.getElementById('totalOverallBalance');
            
            const modal = document.getElementById('transactionModal');
            const modalTitle = document.getElementById('modalTitle');
            const transactionForm = document.getElementById('transactionForm');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            
            const transactionIdInput = document.getElementById('transactionId');
            const dateInput = document.getElementById('date');
            const descriptionInput = document.getElementById('description');
            const categoryInput = document.getElementById('category');
            const amountInput = document.getElementById('amount');

            // --- STATE & KONFIGURASI ---
            const STORAGE_KEY = 'kasRT_data';
            let transactions = [];
            let editingTransactionId = null;

            // --- FUNGSI UTAMA ---
            const loadData = () => {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) {
                    transactions = JSON.parse(data);
                } else {
                    const currentMonth = new Date().toISOString().slice(0, 7);
                    transactions = [
                        { id: generateId(), date: currentMonth + '-01', description: 'Iuran Warga Januari', category: 'Iuran Warga', type: 'pemasukan', amount: 5000000 },
                        { id: generateId(), date: currentMonth + '-05', description: 'Gaji Satpam', category: 'Keamanan (Satpam)', type: 'pengeluaran', amount: 1500000 },
                        { id: generateId(), date: currentMonth + '-10', description: 'Bayar Listrik Jalan', category: 'Listrik & Air', type: 'pengeluaran', amount: 750000 },
                        { id: generateId(), date: currentMonth + '-15', description: 'Sumbangan dari Pak Budi', category: 'Sumbangan Sukarela', type: 'pemasukan', amount: 500000 },
                    ];
                    saveData();
                }
            };

            const saveData = () => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(transactions));
            };

            const generateId = () => '_' + Math.random().toString(36).substr(2, 9);

            const formatCurrency = (amount) => {
                return 'Rp ' + amount.toLocaleString('id-ID');
            };

            const getFilteredTransactions = () => {
                const selectedMonth = monthPicker.value;
                if (!selectedMonth) return transactions;
                return transactions.filter(t => t.date.startsWith(selectedMonth));
            };

            const renderTransactions = () => {
                const filteredTransactions = getFilteredTransactions();
                transactionTableBody.innerHTML = '';

                if (filteredTransactions.length === 0) {
                    const colspan = currentUserRole === 'admin' ? 6 : 5;
                    transactionTableBody.innerHTML = `<tr><td colspan="${colspan}" style="text-align: center; padding: 2rem; color: var(--text-secondary);">Tidak ada transaksi pada bulan ini.</td></tr>`;
                    return;
                }
                
                filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

                filteredTransactions.forEach(trans => {
                    const row = document.createElement('tr');
                    let actionButtonsHtml = '';
                    if (currentUserRole === 'admin') {
                        actionButtonsHtml = `
                            <td class="action-buttons">
                                <button class="btn btn-secondary" onclick="openEditModal('${trans.id}')"><i class="fas fa-edit"></i> Edit</button>
                                <button class="btn btn-danger" onclick="deleteTransaction('${trans.id}')"><i class="fas fa-trash"></i> Hapus</button>
                            </td>
                        `;
                    }

                    row.innerHTML = `
                        <td>${new Date(trans.date).toLocaleDateString('id-ID')}</td>
                        <td>${trans.description}</td>
                        <td>${trans.category}</td>
                        <td><span class="badge badge-${trans.type}">${trans.type.charAt(0).toUpperCase() + trans.type.slice(1)}</span></td>
                        <td style="font-weight: 600; color: ${trans.type === 'pemasukan' ? 'var(--success-color)' : 'var(--danger-color)'};">
                            ${trans.type === 'pemasukan' ? '+' : '-'} ${formatCurrency(trans.amount)}
                        </td>
                        ${actionButtonsHtml}
                    `;
                    transactionTableBody.appendChild(row);
                });
            };

            const updateSummary = () => {
                const filteredTransactions = getFilteredTransactions();
                const totalIncome = filteredTransactions
                    .filter(t => t.type === 'pemasukan')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const totalExpense = filteredTransactions
                    .filter(t => t.type === 'pengeluaran')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const balance = totalIncome - totalExpense;

                totalIncomeEl.textContent = formatCurrency(totalIncome);
                totalExpenseEl.textContent = formatCurrency(totalExpense);
                totalBalanceEl.textContent = formatCurrency(balance);
            };

            const updateOverallSummary = () => {
                const totalIncome = transactions
                    .filter(t => t.type === 'pemasukan')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const totalExpense = transactions
                    .filter(t => t.type === 'pengeluaran')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const overallBalance = totalIncome - totalExpense;
                totalOverallBalanceEl.textContent = formatCurrency(overallBalance);
            };

            // --- FUNGSI AUTENTIKASI YANG DIPERBARUI ---
            const checkAuthStatus = () => {
                const loggedInUser = localStorage.getItem(AUTH_USER_KEY);
                if (loggedInUser) {
                    currentUserRole = loggedInUser;
                    showApp();
                } else {
                    currentUserRole = null;
                    showLogin();
                }
            };

            const showLogin = () => {
                loginContainer.style.display = 'flex';
                appContainer.style.display = 'none';
            };

            const showApp = () => {
                loginContainer.style.display = 'none';
                appContainer.style.display = 'block';
                renderApp();
            };
            
            const renderApp = () => {
                loadData();
                renderTransactions();
                updateSummary();
                updateOverallSummary();
                updateAuthButton();
                updateUIBasedOnRole();
            };
            
            // --- PERUBAHAN: FUNGSI UNTUK MEMBUAT PROFILE DROPDOWN --- 
            const updateAuthButton = () => {
                if (currentUserRole) {
                    const userInitial = currentUserRole.charAt(0).toUpperCase();
                    authButtonContainer.innerHTML = `
                        <div class="user-profile">
                            <div class="profile-trigger">
                                <div class="user-avatar">${userInitial}</div>
                                <span class="user-name">${currentUserRole}</span>
                                <i class="fas fa-chevron-up" style="font-size: 0.8rem; color: var(--text-secondary);"></i>
                            </div>
                            <div class="dropdown-menu" id="profileDropdown">
                                <a href="#" id="logoutLink">
                                    <i class="fas fa-sign-out-alt"></i>
                                    Logout
                                </a>
                            </div>
                        </div>
                    `;
                    
                    // Event Listener untuk dropdown
                    const profileTrigger = authButtonContainer.querySelector('.profile-trigger');
                    const dropdown = document.getElementById('profileDropdown');
                    
                    profileTrigger.addEventListener('click', () => {
                        dropdown.classList.toggle('show');
                    });

                    // Event Listener untuk link logout
                    document.getElementById('logoutLink').addEventListener('click', (e) => {
                        e.preventDefault();
                        handleLogout();
                    });
                }
            };
            // -------------------------------------------------------------

            const updateUIBasedOnRole = () => {
                if (currentUserRole === 'admin') {
                    addTransactionBtn.classList.remove('hidden');
                    actionHeader.classList.remove('hidden');
                } else {
                    addTransactionBtn.classList.add('hidden');
                    actionHeader.classList.add('hidden');
                }
                renderTransactions();
            };
            
            const handleLogin = (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                    localStorage.setItem(AUTH_USER_KEY, ADMIN_CREDENTIALS.username);
                    currentUserRole = ADMIN_CREDENTIALS.username;
                    loginError.style.display = 'none';
                    loginForm.reset();
                    showApp();
                } else if (username === VIEWONLY_CREDENTIALS.username && password === VIEWONLY_CREDENTIALS.password) {
                    localStorage.setItem(AUTH_USER_KEY, VIEWONLY_CREDENTIALS.username);
                    currentUserRole = VIEWONLY_CREDENTIALS.username;
                    loginError.style.display = 'none';
                    loginForm.reset();
                    showApp();
                } else {
                    loginError.style.display = 'block';
                }
            };

            const handleLogout = () => {
                localStorage.removeItem(AUTH_USER_KEY);
                currentUserRole = null;
                checkAuthStatus();
            };
            // ----------------------------------------------

            const openModal = () => {
                modal.classList.add('show');
                if(!editingTransactionId) {
                    dateInput.value = new Date().toISOString().split('T')[0];
                }
            };

            const closeModal = () => {
                modal.classList.remove('show');
                transactionForm.reset();
                editingTransactionId = null;
                modalTitle.innerText = 'Tambah Transaksi Baru';
            };

            const openEditModal = (id) => {
                if (currentUserRole !== 'admin') {
                    alert("Anda tidak memiliki izin untuk melakukan ini.");
                    return;
                }
                editingTransactionId = id;
                const transaction = transactions.find(t => t.id === id);
                if (transaction) {
                    modalTitle.innerText = 'Edit Transaksi';
                    transactionIdInput.value = transaction.id;
                    dateInput.value = transaction.date;
                    descriptionInput.value = transaction.description;
                    categoryInput.value = transaction.category;
                    document.querySelector(`input[name="type"][value="${transaction.type}"]`).checked = true;
                    amountInput.value = transaction.amount;
                    openModal();
                }
            };

            const deleteTransaction = (id) => {
                if (currentUserRole !== 'admin') {
                    alert("Anda tidak memiliki izin untuk melakukan ini.");
                    return;
                }
                if (confirm('Apakah Anda yakin ingin menghapus transaksi ini?')) {
                    transactions = transactions.filter(t => t.id !== id);
                    saveData();
                    renderTransactions();
                    updateSummary();
                    updateOverallSummary();
                }
            };
            
            const exportToPDF = () => {
                exportPdfBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Membuat PDF...';
                exportPdfBtn.disabled = true;

                const element = document.getElementById('printableArea');
                const opt = {
                    margin: 10,
                    filename: `laporan_keuangan_${monthPicker.value || 'semua'}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
                };

                const actionColumns = document.querySelectorAll('.action-buttons');
                actionColumns.forEach(col => col.style.display = 'none');

                html2canvas(element, { scale: 2 }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jspdf.jsPDF('l', 'mm', 'a4');
                    const imgWidth = 297;
                    const pageHeight = 210;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    pdf.save(opt.filename);
                    
                    actionColumns.forEach(col => col.style.display = 'flex');
                    
                    exportPdfBtn.innerHTML = '<i class="fas fa-file-pdf"></i> PDF';
                    exportPdfBtn.disabled = false;
                });
            };

            const exportToExcel = () => {
                const filteredTransactions = getFilteredTransactions();
                
                const ws_data = [
                    ['LAPORAN KEUANGAN KAS RT/RW'],
                    [`Periode: ${monthPicker.value ? new Date(monthPicker.value + '-01').toLocaleDateString('id-ID', { month: 'long', year: 'numeric' }) : 'Semua Periode'}`],
                    [],
                    ['Tanggal', 'Keterangan', 'Kategori', 'Jenis', 'Jumlah (Rp)']
                ];

                filteredTransactions.forEach(t => {
                    ws_data.push([
                        new Date(t.date).toLocaleDateString('id-ID'),
                        t.description,
                        t.category,
                        t.type.charAt(0).toUpperCase() + t.type.slice(1),
                        t.amount
                    ]);
                });

                ws_data.push([]);
                ws_data.push(['RINGKASAN BULAN INI', '', '', '', '']);
                ws_data.push(['Total Pemasukan', '', '', '', filteredTransactions.filter(t => t.type === 'pemasukan').reduce((sum, t) => sum + t.amount, 0)]);
                ws_data.push(['Total Pengeluaran', '', '', '', filteredTransactions.filter(t => t.type === 'pengeluaran').reduce((sum, t) => sum + t.amount, 0)]);
                ws_data.push(['Saldo Akhir Bulan Ini', '', '', '', filteredTransactions.reduce((sum, t) => t.type === 'pemasukan' ? sum + t.amount : sum - t.amount, 0)]);
                
                ws_data.push([]);
                ws_data.push(['RINGKASAN KESELURUHAN', '', '', '', '']);
                const overallIncome = transactions.filter(t => t.type === 'pemasukan').reduce((sum, t) => sum + t.amount, 0);
                const overallExpense = transactions.filter(t => t.type === 'pengeluaran').reduce((sum, t) => sum + t.amount, 0);
                const overallBalance = overallIncome - overallExpense;
                ws_data.push(['Total Pemasukan (Semua)', '', '', '', overallIncome]);
                ws_data.push(['Total Pengeluaran (Semua)', '', '', '', overallExpense]);
                ws_data.push(['Total Kas Keseluruhan', '', '', '', overallBalance]);

                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Laporan Keuangan");

                XLSX.writeFile(wb, `laporan_keuangan_${monthPicker.value || 'semua'}.xlsx`);
            };

            // --- EVENT LISTENERS ---
            loginForm.addEventListener('submit', handleLogin);
            
            // --- PERUBAHAN: EVENT LISTENER UNTUK MENUTUP DROPDOWN ---
            window.addEventListener('click', (e) => {
                // Tutup dropdown jika klik di luar area user-profile
                if (!e.target.closest('.user-profile')) {
                    const dropdown = document.getElementById('profileDropdown');
                    if (dropdown) {
                        dropdown.classList.remove('show');
                    }
                }
                // Tutup modal jika klik di luar area modal
                if (e.target === modal) {
                    closeModal();
                }
            });
            // ---------------------------------------------------------
            
            monthPicker.addEventListener('change', () => {
                renderTransactions();
                updateSummary();
            });

            addTransactionBtn.addEventListener('click', openModal);
            closeModalBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            printBtn.addEventListener('click', () => window.print());
            exportPdfBtn.addEventListener('click', exportToPDF);
            exportExcelBtn.addEventListener('click', exportToExcel);

            transactionForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const transactionData = {
                    date: dateInput.value,
                    description: descriptionInput.value,
                    category: categoryInput.value,
                    type: document.querySelector('input[name="type"]:checked').value,
                    amount: parseInt(amountInput.value)
                };

                if (editingTransactionId) {
                    const index = transactions.findIndex(t => t.id === editingTransactionId);
                    if (index !== -1) {
                        transactions[index] = { ...transactions[index], ...transactionData };
                    }
                } else {
                    const newTransaction = {
                        id: generateId(),
                        ...transactionData
                    };
                    transactions.push(newTransaction);
                }

                saveData();
                renderTransactions();
                updateSummary();
                updateOverallSummary();
                closeModal();
            });

            // --- INISIALISASI ---
            const init = () => {
                const now = new Date();
                monthPicker.value = now.toISOString().slice(0, 7);
                checkAuthStatus();
            };
            
            window.openEditModal = openEditModal;
            window.deleteTransaction = deleteTransaction;

            init();
        });
    </script>
</body>
</html>
